{% extends 'back/base.html.twig' %}

{% block title %}Ajouter page au menu {{ parent() }}{% endblock %}
{% block pageTitle %}Ajouter page au menu{% endblock %}

{% block body %}
    {% block content %}

    <div class="container">
        <div class="pages-list">
            <h2>Liste des pages</h2>
            <ul>
                {% for page in pages %}
                    {% set isPageInMenu = false %}
                    {% for pageMenu in pagesMenu %}
                        {% if page.id == pageMenu.id %}
                            {% set isPageInMenu = true %}
                            {# La page est déjà dans le menu, donc ne l'affichez pas dans la liste #}
                        {% endif %}
                    {% endfor %}

                    {% if not isPageInMenu %}
                        <li>
                            <input type="checkbox" class="page-checkbox" data-page-id="{{ page.id }}" data-page-title="{{ page.title }}">
                            {{ page.title }}
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="menus-container">
            <h2>Page en cours d'ajout</h2>
            <!-- Zone pour afficher les menus sélectionnés -->
        </div>

        <ul>
            {% for page in pagesMenu %}
                <li data-page-id="{{ page.id }}">
                    {{ page.title }}
                    <a href="{{ path('remove_page_from_menu', {'menuId': menu.id, 'pageId': page.id}) }}">Supprimer</a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <button type="button" id="saveButton">Ajouter les pages</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var checkboxes = document.querySelectorAll('.page-checkbox');
            var menuContainer = document.querySelector('.menus-container');
            var saveButton = document.getElementById('saveButton');

            checkboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    if (checkbox.checked) {
                        var pageId = checkbox.getAttribute('data-page-id');
                        var pageTitle = checkbox.getAttribute('data-page-title');
                        
                        var menuElement = document.createElement('div');
                        menuElement.textContent = pageTitle;  // Utilisez pageTitle au lieu de pageId
                        menuElement.setAttribute('data-page-id', pageId);
                        menuContainer.appendChild(menuElement);
                    } else {
                        var pageId = checkbox.getAttribute('data-page-id');
                        var menuElementToRemove = menuContainer.querySelector('div[data-page-id="' + pageId + '"]');
                        if (menuElementToRemove) {
                            menuContainer.removeChild(menuElementToRemove);
                        }
                    }
                });
            });

            saveButton.addEventListener('click', function () {
                var selectedPages = Array.from(checkboxes)
                    .filter(function (checkbox) {
                        return checkbox.checked;
                    })
                    .map(function (checkbox) {
                        return checkbox.getAttribute('data-page-id');
                    });

                var menuId = extractMenuIdFromUrl();

                fetch('/add_pages_to_menu/' + menuId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pageIds: selectedPages }),
                })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Failed to add pages to menu');
                        }
                        console.log('Pages added to menu successfully');
                    })
                    .catch(function (error) {
                        console.error(error.message);
                    });
            });

            function extractMenuIdFromUrl() {
                var path = window.location.pathname;
                var parts = path.split('/').filter(Boolean);
                var menuId = parts[parts.length - 1];
                console.log('Extracted menuId:', menuId);
                return menuId;
            }
        });
    </script>

{% endblock %}
{% endblock %}
